<div class="container-xs new-post-form">
  <div class="new-post-header">
    <img class="avatar new-post-avatar" src="" alt="Your avatar" />
    <h2>Write a New post</h2>
  </div>

  <form action="/api/posts/create" method="post" id="new-post-form">
    <div>
      <label for="title">Title</label>
      <input type="text" name="title" placeholder="Title" required minlength="10" maxlength="64" />
    </div>
    <div>
      <label for="content">Content</label>
      <textarea
        id="new-post-content"
        name="content"
        placeholder="Content"
        minlength="10"
        maxlength="400"
        required
      ></textarea>
      <div id="new-post-remaining-count">400</div>
    </div>
    <div class="form-actions is-compact">
      <button class="button" type="submit" id="create-post-btn">Create post</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('new-post-form')
    const textarea = document.getElementById('new-post-content')
    const charCount = document.getElementById('new-post-remaining-count')
    const submitBtn = document.getElementById('create-post-btn')
    const maxLength = parseInt(textarea.getAttribute('maxlength'), 10)
    let isSubmitting = false

    // Character counter
    textarea.addEventListener('input', () => {
      const remaining = maxLength - textarea.value.length
      charCount.textContent = remaining

      // Reset classes
      charCount.classList.remove('warning', 'danger')

      // Apply color based on remaining characters
      if (remaining < 5) {
        charCount.classList.add('danger')
      } else if (remaining < 20) {
        charCount.classList.add('warning')
      }
    })

    // Prevent multiple submissions
    form.addEventListener('submit', (e) => {
      if (isSubmitting) {
        e.preventDefault()
        return false
      }
      
      isSubmitting = true
      submitBtn.disabled = true
      submitBtn.textContent = 'Creating...'
      
      // Re-enable after 5 seconds as fallback (in case of network issues)
      setTimeout(() => {
        isSubmitting = false
        submitBtn.disabled = false
        submitBtn.textContent = 'Create post'
      }, 5000)
    })

    // Update avatar with user data from auth-gate
    const authDiv = document.querySelector('[data-username]')
    const avatar = document.querySelector('.new-post-avatar')

    if (authDiv && avatar) {
      const username = authDiv.getAttribute('data-username')
      const avatarSrc = authDiv.getAttribute('data-avatar-src')

      if (avatarSrc) {
        avatar.src = avatarSrc
        avatar.alt = username + "'s avatar"
      }
    }
  })
</script>
