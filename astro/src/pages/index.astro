---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Feedback from '../components/Feedback.astro';
import PostsIsland from '../components/PostsIsland.astro';
import SubmitButton from '../components/react/SubmitButton.tsx';
import { getCurrentUserFromAstro } from '../utils/auth.ts';

const user = await getCurrentUserFromAstro(Astro.cookies);

// Get page from URL params
const url = new URL(Astro.request.url);
const pageParam = url.searchParams.get('page');
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
---

<BaseLayout title="Feed">
  <Header />
  <Feedback />
  
  {user ? (
    <div class="container-xs new-post-form">
      <form action="/api/posts/create" method="post" id="post-form">
        <div class="form-field">
          <label for="title">Title</label>
          <input type="text" name="title" id="title" required maxlength="64" />
        </div>
        <div class="form-field">
          <label for="content">Content</label>
          <textarea name="content" id="content" required maxlength="400" rows="4"></textarea>
        </div>
        <SubmitButton formId="post-form" loadingText="Creating post..." client:idle>
          Create Post
        </SubmitButton>
      </form>
    </div>
  ) : (
    <div class="container-xs new-post-form guest">
      <div class="auth-prompt">
        <h2>Share your thoughts</h2>
        <p>Sign in to create posts and join the conversation.</p>
        <div class="form-actions">
          <a class="button" href="/login">Sign in</a>
          <a class="button secondary" href="/register">Create account</a>
        </div>
      </div>
    </div>
  )}

  <div class="container">
    <h1>Latest posts</h1>
    <div class="post-card-grid">
      <PostsIsland page={currentPage} server:defer>
        <div slot="fallback">
          <p>Loading posts...</p>
        </div>
      </PostsIsland>
    </div>
  </div>
</BaseLayout>