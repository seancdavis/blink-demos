---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Feedback from '../components/Feedback.astro';
import { isAuthenticated } from '../utils/auth.ts';

// Redirect authenticated users away from login page
if (await isAuthenticated(Astro.cookies)) {
  return Astro.redirect('/');
}
---

<BaseLayout title="Login">
  <Header />
  <Feedback />

  <main>
    <div class="container-xs">
      <h1>Sign in</h1>

      <form action="/api/auth/login" method="post" id="login-form">
        <div>
          <label for="username">username</label>
          <input type="text" name="username" id="username" required autofocus />
        </div>

        <div>
          <label for="password">Password</label>
          <input type="password" name="password" id="password" minlength="8" required />
        </div>

        <div class="form-actions">
          <button class="button" type="submit" id="login-btn">Sign in</button>
          <span class="form-actions-link">
            Don't have an account? <a href="/register">Create an account</a>
          </span>
        </div>
      </form>

      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const form = document.getElementById('login-form') as HTMLFormElement
          const submitBtn = document.getElementById('login-btn') as HTMLButtonElement
          let isSubmitting = false

          if (form && submitBtn) {
            form.addEventListener('submit', (e) => {
              if (isSubmitting) {
                e.preventDefault()
                return false
              }

              isSubmitting = true
              submitBtn.disabled = true
              submitBtn.textContent = 'Signing in...'

              // Re-enable after 5 seconds as fallback (in case of network issues)
              setTimeout(() => {
                isSubmitting = false
                submitBtn.disabled = false
                submitBtn.textContent = 'Sign in'
              }, 5000)
            })
          }
        })
      </script>
    </div>
  </main>
</BaseLayout>