---
import { getCurrentUserFromAstro } from '../utils/auth.ts';

const user = await getCurrentUserFromAstro(Astro.cookies);
---

<header>
  <div class="header-content container">
    <a class="header-logo" href="/">
      <img src="/images/blink-logo.svg" alt="BLINK Logo" />
    </a>
    <nav>
      {user ? (
        <details class="header-auth-links signed-in" data-username={user.username} data-avatar-src={user.avatarSrc} data-user-id={user.id}>
          <summary>
            <img class="avatar" src={user.avatarSrc} alt={`${user.username} avatar`} />
          </summary>
          <div class="header-auth-links-dropdown">
            <a href={`/@${user.username}`} class="profile-link">{user.username}</a>
            <a href="/settings">Edit profile</a>
            <form action="/api/auth/logout" method="post">
              <button class="sign-out" type="submit">Sign out</button>
            </form>
          </div>
        </details>
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const dropdown = document.querySelector('.header-auth-links') as HTMLDetailsElement

            // Close dropdown on outside click or Escape key
            if (dropdown) {
              // Close on outside click
              document.addEventListener('click', (e) => {
                if (e.target && !dropdown.contains(e.target as Node)) {
                  dropdown.open = false
                }
              })

              // Close on Escape key
              document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && dropdown.open) {
                  dropdown.open = false
                }
              })
            }
          })
        </script>
      ) : (
        <a class="button" href="/login">Sign in</a>
      )}
    </nav>
  </div>
</header>